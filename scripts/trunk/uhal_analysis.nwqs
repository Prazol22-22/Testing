<QuerySet>
  <Query IsView="False" IsSP="False">
    <SQL>select distinct 
mbr_num,BRTH_DT
from raw_usi.raw_cigna_ecbarton_rxclaim

select left(MBR_num,9),* from raw_usi.raw_cigna_ecbarton_rxclaim
where left(MBR_num,9)  in 
(
select distinct left(MBR_num,9) from raw_usi.raw_cigna_ecbarton_rxclaim
group by 1
having count(distinct FRST_NM)&gt;1)



select distinct METRC_QTY from raw_usi.raw_cigna_ecbarton_rxclaim	




select HOSP_DAYS_CNT,datediff (days,cast(SVC_DT as date),cast(END_DT as date)),cast(SVC_DT as date),cast(END_DT as date)
from raw_usi.raw_cigna_ecbarton_medclaim



select * from raw_usi.raw_cigna_ecbarton_medclaim
where HOSP_DAYS_CNT = '35'



select ssn,* from raw_usi.raw_cigna_ecbarton_elig
where ssn  in 
(
select distinct ssn from raw_usi.raw_cigna_ecbarton_elig
group by 1
having count(distinct pat_first_name)&gt;1)
 raw_usi.	ssn




</SQL>
    <Name>Tab 12</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Claim type Distribution  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

select 
b.billtype
,count(distinct a.prv_npi) as "Count"
,sum(cast(pdamt as float)) as  Amount 
from raw_tfk.raw_bcbsal_uhaul_medical a
join master_deerwalk.dw_master_npi b
on a.prv_npi = b.npi
group by 1


select distinct ClmType,TOB,TOBDesc, count(*),sum(cast(pdamt as float)) from raw_tfk.raw_bcbsal_uhaul_medical
group by 1,2,3
--------------------------------------------------------------------------------------------------------------------------------------------------------
------------ClaimID + Claimline_number Distribution  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------


------------Count Record of ClaimID + Claimline_number Distribution  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

select count(distinct rev_claim_id||rev_claim_line_id),count(*) from raw_tfk.raw_bcbsal_uhaul_medical;

------------ Distinct Count Record of ClaimID + Claimline_number Distribution  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
select count(distinct rev_claim_id||rev_claim_line_id)
,sum(cast(pdamt as float)) as  Amount
from  raw_tfk.raw_bcbsal_uhaul_medical;


--------------------------------------------------------------------------------------------------------------------------------------------------------
------------POS Match  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

select sum(cast(pdamt as float)) as  Amount from raw_tfk.raw_bcbsal_uhaul_medical a
join master_deerwalk.dw_master_pos b
on 
a.svc_pos_code=b.code


--------------------------------------------------------------------------------------------------------------------------------------------------------
------------POS Mismatch  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

select sum(cast(pdamt as float)) as  Amount from raw_tfk.raw_bcbsal_uhaul_medical a
join master_deerwalk.dw_master_pos b
on 
a.svc_pos_code&lt;&gt;b.code
'026229'

select top 100 * from  raw_tfk.raw_bcbsal_uhaul_medical
--------------------------------------------------------------------------------------------------------------------------------------------------------
------------NPI Match DISTRIBUTION  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

------------NPI Match Count and Amount DISTRIBUTION  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
select 
 count(distinct prv_npi) 
,sum(cast(pdamt as float)) as  Amount
from raw_tfk.raw_bcbsal_uhaul_medical
where  
prv_npi 
in
(
select distinct a.prv_npi
from raw_tfk.raw_bcbsal_uhaul_medical a
join master_deerwalk.dw_master_npi b
on a.prv_npi=b.npi
)

------------Mismatch NPI Code Distribution	  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
select 
 distinct prv_npi 
,sum(cast(pdamt as float)) as  Amount
from raw_tfk.raw_bcbsal_uhaul_medical
where  
prv_npi not
in
(
select distinct a.prv_npi
from raw_tfk.raw_bcbsal_uhaul_medical a
join master_deerwalk.dw_master_npi b
on a.prv_npi=b.npi
)
group by 1;
	

--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Network Flag Match DISTRIBUTION  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

select  
NetworkInd
,count(*)
,sum(cast(pdamt as float)) as  Amount
from raw_tfk.raw_bcbsal_uhaul_medical
group by 1;


--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Service Frm Date Analysis  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Update date in date_format(YYYY-MM_DD)  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

--update raw_tfk.raw_bcbsal_uhaul_medical
--set svc_service_frm_date = cast(svc_service_frm_date as date);
--
--update raw_tfk.raw_bcbsal_uhaul_medical
--set svc_service_to_date = cast(svc_service_to_date as date);
--
--update raw_tfk.raw_bcbsal_uhaul_medical
--set rev_paid_date = cast(rev_paid_date as date);

-----------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------
select count(cast(svc_service_frm_date as date))
from raw_tfk.raw_bcbsal_uhaul_medical 
where cast(svc_service_frm_date as date)  not in 
(
select cast(cast(svc_service_frm_date as date) as date) from raw_tfk.raw_bcbsal_uhaul_medical where cast(cast(svc_service_frm_date as date) as date) is null
);

--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Service To Date Analysis  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
select count(cast(svc_service_to_date as date)) 
from raw_tfk.raw_bcbsal_uhaul_medical 
where cast(svc_service_to_date as date) not in
(
select cast(svc_service_to_date as date) from raw_tfk.raw_bcbsal_uhaul_medical where cast(svc_service_to_date as date) is null
);

--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Paid Date Analysis  --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
select count(cast(rev_paid_dat1e as date)) 
from raw_tfk.raw_bcbsal_uhaul_medical 
where cast(rev_paid_dat1e as date) not in
(
select count(cast(rev_paid_dat1e as date)) from raw_tfk.raw_bcbsal_uhaul_medical where cast(rev_paid_dat1e as date) is null
);



select count(*),count(FirstSvcDt)
raw_tfk.raw_bcbsal_uhaul_medical ;

select count(*) from raw_tfk.raw_bcbsal_uhaul_medical ;
	select  count(PaidMonth) from raw_tfk.raw_bcbsal_uhaul_medical
	where len(PaidMonth)&lt;6;
	select  count(LastSvcDt)	 from raw_tfk.raw_bcbsal_uhaul_medical ;
	select  count(AdmDt)	 from raw_tfk.raw_bcbsal_uhaul_medical ;
	select  count(DischDt)  from raw_tfk.raw_bcbsal_uhaul_medical ;
--------------------------------------------------------------------------------------------------------------------------------------------------------
------------cast(svc_service_frm_date as date) &gt; cast(svc_service_to_date as date) --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
select 
  cast(svc_service_frm_date as date)
, cast(svc_service_to_date as date)
, sum(cast(pdamt as float)) as Amount
from raw_tfk.raw_bcbsal_uhaul_medical 
where (cast(svc_service_frm_date as date) &gt; cast(svc_service_to_date as date))
group by 1,2;

--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Copay Amount Distribution --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
select 
distinct cast(rev_copay_amt as float) as rev_copay_amt
,count(*)
from raw_tfk.raw_bcbsal_uhaul_medical
group by 1 
order by 2 desc 
limit 10;

--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Claims Amount Distribution --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

select sum(cast (pdamt as float)) as paid_amount from raw_tfk.raw_bcbsal_uhaul_medical;
select sum(cast (rev_allowed_amt as float)) as allowed_amount from raw_tfk.raw_bcbsal_uhaul_medical;
select sum(cast (rev_billed_amt as float)) as total_billed_amount from raw_tfk.raw_bcbsal_uhaul_medical;
select sum(cast (rev_coinsurance_amt as float)) as coinsurance_amount from raw_tfk.raw_bcbsal_uhaul_medical;
select sum(cast (rev_deductible_amt as float)) as deductible_amount from raw_tfk.raw_bcbsal_uhaul_medical;


--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Diagnosis Match Distribution --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

Diag1	varchar(200),
Diag2	varchar(200),
Diag3	varchar(200),
Diag4	varchar(200),
Diag5


select count(distinct coalesce(isnull(diag1), isnull(diag2), isnull(diag3),isnull(diag4),isnull(diag5))),sum(cast(pdamt as float))
from raw_tfk.raw_bcbsal_uhaul_medical; --  11566 100204826.92

select null,isnull(null,'abc')


select count(distinct coalesce(b.code,b1.code,c.code,c1.code,d.code,d1.code,e.code,e1.code,f.code,f1.code))
,sum(cast(a.pdamt as float))
from raw_tfk.raw_bcbsal_uhaul_medical a
left join master_deerwalk.dw_master_diagnosis b
on a.diag1=replace(b.code,'.','')
and b.icd10flag = 'N'
 left join master_deerwalk.dw_master_diagnosis b1
on a.diag1=replace(b1.code,'.','')
and b1.icd10flag = 'Y'
left join master_deerwalk.dw_master_diagnosis c
on a.diag2=replace(c.code,'.','')
and c.icd10flag = 'N'
 left join master_deerwalk.dw_master_diagnosis c1
on a.diag2=replace(c1.code,'.','')
and c1.icd10flag = 'Y'
left join master_deerwalk.dw_master_diagnosis d
on a.diag3=replace(d.code,'.','')
and d.icd10flag = 'N'
 left join master_deerwalk.dw_master_diagnosis d1
on a.diag3=replace(d1.code,'.','')
and d1.icd10flag = 'Y'
left join master_deerwalk.dw_master_diagnosis e
on a.diag4=replace(e.code,'.','')
and  e.icd10flag = 'N'
 left join master_deerwalk.dw_master_diagnosis e1
on a.diag4=replace(e1.code,'.','')
and e1.icd10flag = 'Y'
left join master_deerwalk.dw_master_diagnosis f
on a.diag5=replace(f.code,'.','')
and f.icd10flag = 'N'
 left join master_deerwalk.dw_master_diagnosis f1
on a.diag5=replace(f1.code,'.','')
and f1.icd10flag = 'Y'
where coalesce(b.code,b1.code,c.code,c1.code,d.code,d1.code,e.code,e1.code,f.code,f1.code) is not null

-- 11597 104103104.91

select count(distinct coalesce(b.code,b1.code,c.code,c1.code,d.code,d1.code,e.code,e1.code,f.code,f1.code))
,sum(cast(a.pdamt as float))
from raw_tfk.raw_bcbsal_uhaul_medical a
left join master_deerwalk.dw_master_diagnosis b
on a.diag1=replace(b.code,'.','')
and b.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis b1
on a.diag1=replace(b1.code,'.','')
and b1.icd10flag = 'Y'
and a.icdversion = '10'
left join master_deerwalk.dw_master_diagnosis c
on a.diag2=replace(c.code,'.','')
and c.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis c1
on a.diag2=replace(c1.code,'.','')
and c1.icd10flag = 'Y'
and a.icdversion = '10'
left join master_deerwalk.dw_master_diagnosis d
on a.diag3=replace(d.code,'.','')
and d.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis d1
on a.diag3=replace(d1.code,'.','')
and d1.icd10flag = 'Y'
and a.icdversion = '10'
left join master_deerwalk.dw_master_diagnosis e
on a.diag4=replace(e.code,'.','')
and  e.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis e1
on a.diag4=replace(e1.code,'.','')
and e1.icd10flag = 'Y'
and a.icdversion = '10'
left join master_deerwalk.dw_master_diagnosis f
on a.diag5=replace(f.code,'.','')
and f.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis f1
on a.diag5=replace(f1.code,'.','')
and f1.icd10flag = 'Y'
and a.icdversion = '10'
where coalesce(b.code,b1.code,c.code,c1.code,d.code,d1.code,e.code,e1.code,f.code,f1.code) is not null
-------------

select distinct a.diag1,b.code,b1.code,a.diag2,c.code,c1.code,a.diag3,d.code,d1.code,a.diag4,e.code,e1.code,a.diag5,f.code,f1.code
--,sum(cast(a.pdamt as float))
from raw_tfk.raw_bcbsal_uhaul_medical a
left join master_deerwalk.dw_master_diagnosis b
on a.diag1=replace(b.code,'.','')
and b.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis b1
on a.diag1=replace(b1.code,'.','')
and b1.icd10flag = 'Y'
and a.icdversion = '10'
left join master_deerwalk.dw_master_diagnosis c
on a.diag2=replace(c.code,'.','')
and c.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis c1
on a.diag2=replace(c1.code,'.','')
and c1.icd10flag = 'Y'
and a.icdversion = '10'
left join master_deerwalk.dw_master_diagnosis d
on a.diag3=replace(d.code,'.','')
and d.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis d1
on a.diag3=replace(d1.code,'.','')
and d1.icd10flag = 'Y'
and a.icdversion = '10'
left join master_deerwalk.dw_master_diagnosis e
on a.diag4=replace(e.code,'.','')
and  e.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis e1
on a.diag4=replace(e1.code,'.','')
and e1.icd10flag = 'Y'
and a.icdversion = '10'
left join master_deerwalk.dw_master_diagnosis f
on a.diag5=replace(f.code,'.','')
and f.icd10flag = 'N'
and a.icdversion = '9'
 left join master_deerwalk.dw_master_diagnosis f1
on a.diag5=replace(f1.code,'.','')
and f1.icd10flag = 'Y'
and a.icdversion = '10'
where coalesce(b.code,b1.code,c.code,c1.code,d.code,d1.code,e.code,e1.code,f.code,f1.code) is  null



select * from  raw_tfk.raw_bcbsal_uhaul_medical
where diag1 = 'N/A'


----------Data has dental too;

select * from master_deerwalk.dw_master_procedure
where code  in 
(
'D7140','D1120')



--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Procedure Match Distribution --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

select 
count
(
distinct coalesce(
case when Procedure ,
case when SurgProc1Cd,
case when SurgProc2Cd ,
case when SurgProc3Cd ,
case when SurgProc4Cd ,
case when SurgProc5Cd ,
case when revcd ,
case when drgcd ,
)
)
,sum(cast(pdamt as float)) 
from  
raw_tfk.raw_bcbsal_uhaul_medical a ; --6483 --6768


select 
count
(
distinct coalesce(b.code,b.procedure_type,c.code,c.procedure_type,
d.code,d.procedure_type,e.code,e.procedure_type,
f.code,f.procedure_type,g.code,g.procedure_type)
)
, sum(cast(pdamt as float))
from raw_tfk.raw_bcbsal_uhaul_medical a
left join master_deerwalk.dw_master_procedure b
on
a.Procedure = b.code
and b.procedure_type = 'CPT4'
left join  master_deerwalk.dw_master_procedure c
on
a.svc_hcpcs_code = c.code
and c.procedure_type = 'HCPCS'
left join master_deerwalk.dw_master_procedure d
on
a.svc_icd_proc_1_code = d.code
and d.procedure_type = 'ICD9'
left join master_deerwalk.dw_master_procedure e
on
a.svc_icd_proc_1_code = E.code
and e.procedure_type = 'ICD10'
left join master_deerwalk.dw_master_procedure f
on
'R'||right(a.svc_rev_code,3) = f.code
and f.procedure_type not like '%DRG%' 
left join master_deerwalk.dw_master_procedure g
on
right(a.svc_drg_code ,3)= g.code
and g.procedure_type= 'DRG 27'
where nvl(b.code,c.code,d.code,e.code,f.code,g.code) is not  null;
										
--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Procedure Match Count and Amount Distribution --------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------

select  procedure,RevCd,count(*),sum(cast(pdamt as float)) from  raw_tfk.raw_bcbsal_uhaul_medical
where len(revcd)&gt;3
group by 1,2

select * from master_deerwalk.dw_master_procedure
where code in
(
'J0295','90999','R1002','R1001','R1000')


select distinct  
case when len(revcd) = 3 then 'R'||revcd
 when len(revcd) &gt; 3 and substring(revcd,1,1) &lt;&gt; '0' then 'R'||revcd 
 when len(revcd) &gt; 3 and substring(revcd,1,1) = '0' then'R'||right(revcd,3) end
, revcd from raw_tfk.raw_bcbsal_uhaul_medical


select * from  master_deerwalk.dw_master_procedure
where procedure_type like 'Re%'
and len(code)&gt;4

select distinct len(code),procedure_type from master_deerwalk.dw_master_procedure
where procedure_type like 'Re%'
--coalesce(b.procedure_type,c.procedure_type,d.procedure_type,e.procedure_type,f.procedure_type,g.procedure_type)
--,sum(cast(pdamt as float)) ,

select
coalesce(b.procedure_type,c.procedure_type,d.procedure_type,d1.procedure_type,e.procedure_type,e1.procedure_type,f.procedure_type,f1.procedure_type,g.procedure_type,g1.procedure_type,h.procedure_type,h1.procedure_type,i.procedure_type,j.procedure_type),count(distinct coalesce(b.code,c.code,d.code,d1.code,e.code,e1.code,f.code,f1.code,g.code,g1.code,h.code,h1.code,i.code,j.code)),

select distinct 
procedure,
SurgProc1Cd,
SurgProc2Cd ,
SurgProc3Cd ,
SurgProc4Cd ,
SurgProc5Cd ,
revcd ,
drgcd ,cast(pdamt as float)
from raw_tfk.raw_bcbsal_uhaul_medical a
left join master_deerwalk.dw_master_procedure b
on
a.Procedure = b.code
and b.procedure_type = 'CPT4'
left join  master_deerwalk.dw_master_procedure c
on
a.Procedure = c.code
and c.procedure_type = 'HCPCS'
left join master_deerwalk.dw_master_procedure d 
on
a.SurgProc1Cd =  d.code
and d.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure d1 
on
a.SurgProc1Cd =  d1.code
and d1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure e 
on
a.SurgProc2Cd =  e.code
and e.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure e1 
on
a.SurgProc2Cd =  e1.code
and e1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure f 
on
a.SurgProc3Cd =  f.code
and f.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure f1 
on
a.SurgProc3Cd =  f1.code
and f1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure g 
on
a.SurgProc4Cd =  g.code
and g.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure g1 
on
a.SurgProc4Cd =  g1.code
and g1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure h 
on
a.SurgProc5Cd =  h.code
and h.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure h1 
on
a.SurgProc5Cd =  h1.code
and h1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure i
on
case when len(revcd) = 3 then 'R'||revcd
 when len(revcd) &gt; 3 and substring(revcd,1,1) &lt;&gt; '0' then 'R'||revcd 
 when len(revcd) &gt; 3 and substring(revcd,1,1) = '0' then'R'||right(revcd,3) end = f.code
and f.procedure_type not like '%DRG%' 
left join master_deerwalk.dw_master_procedure j
on
right(a.DRGCd ,3)= g.code
and g.procedure_type= 'DRG 27'

where coalesce(b.code,c.code,d.code,d1.code,e.code,e1.code,f.code,f1.code,g.code,g1.code,h.code,h1.code,i.code,j.code) is   null
group by coalesce(b.procedure_type,c.procedure_type,d.procedure_type,d1.procedure_type,e.procedure_type,e1.procedure_type,f.procedure_type,f1.procedure_type,g.procedure_type,g1.procedure_type,h.procedure_type,h1.procedure_type,i.procedure_type,j.procedure_type);



select distinct len(code) from master_deerwalk.dw_master_procedure
where procedure_type =  'DRG 27'


select SurgProc1Cd,icdversion,code,procedure_type
from  raw_tfk.raw_bcbsal_uhaul_medical
join master_deerwalk.dw_master_procedure
on SurgProc1Cd = code


select distinct subid_encrypt, mbrid_encrypt, mbrfirst, mbrlast,mbryob,ssn,relationship from raw_tfk.raw_bcbsal_uhaul_eligibility
where subid_encrypt in 
(
select distinct subid_encrypt from raw_tfk.raw_bcbsal_uhaul_eligibility
group by 1
having count(distinct mbrfirst)&gt;1);


select distinct relationship from  raw_tfk.raw_bcbsal_uhaul_medical
</SQL>
    <Name>Tab 11</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>select distinct udf16,ins_division_id,ins_division_name from 
stage1_tfk_20161109.perm_stage1_eligibility;</SQL>
    <Name>Tab 14</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>select DISTINCT ins_emp_group_id from stage1_usi_dsp_20160929.perm_stage1_eligibility 
where ins_emp_group_id ~* '[^a-z0-9]';




select date_part(year,cast(a.ADJUDICATION_DATE  as date)) as "YEAR", date_part(month,cast(a.ADJUDICATION_DATE as date)) as "MONTH" , count(*), sum(cast (a.CLIENT_AMOUNT_DUE as float)/100) as Paid_Amount
from
raw_tfk.tfk_ethos_express_Pharmacy a
WHERE exists
(
SELECT NULL FROM raw_tfk.raw_tfk_ethos_express_20161201 b
where a.TRANSACTION_ID=b.TRANSACTION_ID
and date_part(year,cast(ADJUDICATION_DATE  as date)='2016'
and date_part(month,cast(ADJUDICATION_DATE as date)='9'
and RECORD_CODE = '4'
)
group  by 1,2
order by 1,2;</SQL>
    <Name>Tab 9</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>select top 100 * from 
raw_tfk.raw_bcbsal_uhaul_eligibility;
select top 100 * from 
raw_tfk.raw_bcbsal_uhaul_medical;


select count(distinct subid_encrypt||mbrid_encrypt)
from raw_tfk.raw_bcbsal_uhaul_medical a -- 18402
where exists
(
	select null from raw_tfk.raw_bcbsal_uhaul_eligibility b
		where 
			a.subid_encrypt||a.mbrid_encrypt = b.subid_encrypt||b.mbrid_encrypt); -- 17581
			
select count(distinct mbrlast||mbrfirst||mbryob)
from raw_tfk.raw_bcbsal_uhaul_medical a -- 18019
where exists
(
	select null from raw_tfk.raw_bcbsal_uhaul_eligibility b
		where 
			a.mbrlast||a.mbrfirst||a.mbryob = b.mbrlast||b.mbrfirst||b.mbryob);	 -- 17501
			
			
			cast(segmenteffdt as date), 
			cast(segmentenddt as date)
	
	
	
	select distinct udf1,udf2,ins_emp_group_name from stage1_usi_20161201_i4.perm_stage1_eligibility;
	select distinct udf1,udf2,ins_emp_group_name from stage1_usi_20161201_i4.perm_stage1_med_claims;
	select distinct udf1,udf2,ins_emp_group_name from stage1_usi_20161201_i4.perm_stage1_rx_claims;
	
	
	select distinct dw_member_id from stage1_usi_20161201_i4.perm_stage1_rx_claims
	where ins_emp_group_name = 'EC Barton'
	and dw_member_id in
		(
			select distinct dw_member_id from stage1_usi_20161201_i4.perm_stage1_eligibility
	where ins_emp_group_name = 'EC Barton' )
	
	
	select distinct dw_member_id from stage1_usi_20161201_i4.perm_stage1_med_claims
	where ins_emp_group_name = 'EC Barton';
	
	
	select  * from raw_usi.raw_usi_diocese_of_venice_pharmacy_expressscripts_20161104
	limit 1;
	
	select distinct from raw_usi.raw_usi_diocese_of_venice_pharmacy_expressscripts_20161104
			
	</SQL>
    <Name>Tab 3</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>select top 100 * from raw_tfk.raw_bcbsal_uhaul_eligibility;


select date_part(year,cast(segmenteffdt as date)) as "YEAR",
 date_part(month,cast(segmenteffdt as date)) as "MONTH",
count(*) from   raw_tfk.raw_bcbsal_uhaul_eligibility
group by 1,2
order by 1,2;
select date_part(year,cast(segmentenddt as date)) as "YEAR",
date_part(month,cast(segmentenddt as date)) as "MONTH",
count(*) from   raw_tfk.raw_bcbsal_uhaul_eligibility
group by 1,2
order by 1,2 ;



select top 10 * from raw_tfk.raw_bcbsal_uhaul_medical

delete from raw_tfk.raw_bcbsal_uhaul_medical
where paidmonth = 'PaidMonth';
select date_part(year,cast(paidmonth||'01' as date)) as "YEAR",
date_part(month,cast(paidmonth||'01'  as date)) as "MONTH",
count(*),sum(cast(pdamt as float)) from   raw_tfk.raw_bcbsal_uhaul_medical
group by 1,2
order by 1,2 ;


delete from raw_tfk.raw_bcbsal_uhaul_medical
where paidmonth = 'PaidMonth';
select date_part(year,cast(firstsvcdt as date)) as "YEAR",
date_part(month,cast(firstsvcdt as date)) as "MONTH",
count(*),sum(cast(pdamt as float)) from   raw_tfk.raw_bcbsal_uhaul_medical
group by 1,2
order by 1,2 ;


select distinct paidmonth from  raw_tfk.raw_bcbsal_uhaul_medical
, 
select * from raw_tfk.raw_bcbsal_uhaul_medical
where subid_encrypt||mbrid_encrypt in
(
'54092210750',
'54928241428')


select cast ('05/15/2015' as date)

select distinct firstsvcdt from raw_tfk.raw_bcbsal_uhaul_medical

select * from raw_tfk.raw_bcbsal_uhaul_medical where firstsvcdt = ''




select distinct groupid, groupname, 'BCBSAL' AS carrier,'BCBSAL' AS CARRIERNAME,plan, plan as planname, 'BK' as unit, 'Blank' as unitdesc, homestate as location,  homestate as locationdesc,  grpdiv, grpdiv,'BK' as employetype, 'Blank' as employetypedesc
from  raw_tfk.raw_bcbsal_uhaul_eligibility


select count(*) from   raw_tfk.raw_bcbsal_uhaul_eligibility;
select count(*) from   raw_tfk.raw_bcbsal_uhaul_medical;
</SQL>
    <Name>Tab 6</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <File>../../../../data/workforce/traffk/uhaul/eligibility%20analysis.sql</File>
    <Name>eligibility analysis</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>select distinct pdamt from  raw_tfk.raw_bcbsal_uhaul_medical


select sum(cast(pdamt as float)), sum(pdamt) from raw_tfk.raw_bcbsal_uhaul_medical
where pdamt &lt;&gt; 'PdAmt'


select
coalesce(b.procedure_type,c.procedure_type,i.procedure_type,d.procedure_type,d1.procedure_type,e.procedure_type,e1.procedure_type,f.procedure_type,f1.procedure_type,g.procedure_type,g1.procedure_type,h.procedure_type,h1.procedure_type,j.procedure_type),
count(distinct coalesce(b.code,c.code,i.code,d.code,d1.code,e.code,e1.code,f.code,f1.code,g.code,g1.code,h.code,h1.code,j.code)),
--a.procedure,a.SurgProc1Cd,a.SurgProc2Cd,a.SurgProc3Cd,a.SurgProc4Cd ,a.SurgProc5Cd,a.revcd ,a.drgcd ,
sum(cast(pdamt as float)), sum(pdamt)
--distinct 
-- Procedure ,
-- SurgProc1Cd,
-- SurgProc2Cd ,
-- SurgProc3Cd ,
-- SurgProc4Cd ,
-- SurgProc5Cd ,
-- revcd ,case when len(revcd) = 3 then 'R'||revcd
-- when len(revcd) &gt; 3 and substring(revcd,1,1) &lt;&gt; '0' then 'R'||revcd 
-- when len(revcd) &gt; 3 and substring(revcd,1,1) = '0' then'R'||right(revcd,3) end,
from raw_tfk.raw_bcbsal_uhaul_medical a
left join master_deerwalk.dw_master_procedure b
on
a.Procedure = b.code
and b.procedure_type = 'CPT4'
left join  master_deerwalk.dw_master_procedure c
on
a.Procedure = c.code
and c.procedure_type = 'HCPCS'
left join master_deerwalk.dw_master_procedure i
on
case when len(revcd) = 3 then 'R'||revcd
when len(revcd) &gt; 3 and substring(revcd,1,1) &lt;&gt; '0' then 'R'||revcd 
when len(revcd) &gt; 3 and substring(revcd,1,1) = '0' then'R'||right(revcd,3) end = i.code
and i.procedure_type not like '%DRG%' 
left join master_deerwalk.dw_master_procedure d 
on
a.SurgProc1Cd =  d.code
and d.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure d1 
on
a.SurgProc1Cd =  d1.code
and d1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure e 
on
a.SurgProc2Cd =  e.code
and e.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure e1 
on
a.SurgProc2Cd =  e1.code
and e1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure f 
on
a.SurgProc3Cd =  f.code
and f.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure f1 
on
a.SurgProc3Cd =  f1.code
and f1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure g 
on
a.SurgProc4Cd =  g.code
and g.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure g1 
on
a.SurgProc4Cd =  g1.code
and g1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure h 
on
a.SurgProc5Cd =  h.code
and h.procedure_type = 'ICD9'
and a.icdversion = '9'
left join master_deerwalk.dw_master_procedure h1 
on
a.SurgProc5Cd =  h1.code
and h1.procedure_type = 'ICD10'
and a.icdversion = '10'
left join master_deerwalk.dw_master_procedure j
on
right(a.DRGCd ,3)= j.code
and j.procedure_type= 'DRG 27'
where coalesce(b.code,c.code,i.code,d.code,d1.code,e.code,e1.code,f.code,f1.code,g.code,g1.code,h.code,h1.code,j.code) is not  null
--group by a.procedure,a.SurgProc1Cd,a.SurgProc2Cd,a.SurgProc3Cd,a.SurgProc4Cd ,a.SurgProc5Cd,a.revcd ,a.drgcd;
group by coalesce(b.procedure_type,c.procedure_type,i.procedure_type,d.procedure_type,d1.procedure_type,e.procedure_type,e1.procedure_type,f.procedure_type,f1.procedure_type,g.procedure_type,g1.procedure_type,h.procedure_type,h1.procedure_type,j.procedure_type);</SQL>
    <Name>Tab 20</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <File>../../../../data/workforce/traffk/uhaul/elig%20import.sql</File>
    <Name>elig import</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>select distinct prv_dea,prv_npi,prv_prescriber_id, prv_prescriber_first_name from stage1_tfk_20161109.perm_stage1_rx_claims

select distinct rev_billed_amt,rev_paid_amt,rev_allowed_amt, rev_coinsurance_amt,
rev_copay_amt,
rev_deductible_amt
 from stage1_tfk_20161109.perm_stage1_rx_claims


select top 10 * from 




select isnull(b.billtype,'UB04'),count(distinct ServicingProviderNPI),sum(cast(PaidAmount as float))/100 
from raw_tfk.raw_ethos_aetna_medical a
left join
master_deerwalk.dw_master_npi b
on a.ServicingProviderNPI=b.npi
 where a.subgroup_nbr&lt;&gt; '00000030'
-- where b.npi is not null
group by 1;

select rev_claim_type,count(distinct prv_npi),sum(rev_paid_amt)
from stage1_tfk_20161109.perm_stage1_med_claims
group by 1


select distinct dw_rawfilename from stage1_tfk_20161109.perm_stage1_med_claims;
select distinct filename from raw_tfk.raw_ethos_aetna_medical 


</SQL>
    <Name>Tab 17</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>select distinct TRANSACTION_STATUS,count(*) from 
raw_tfk.raw_traffk_ethos_esi_pharmacy_20161028	
group by 1



select distinct  ins_plan_id, ins_plan_desc, ins_division_id, ins_division_name, udf20,udf21,  udf18,udf19,  udf16,udf17 
from stage1_tfk_20161109.perm_stage1_rx_claims


select distinct svc_rev_code,
svc_rev_desc from stage1_tfk_20161109.perm_stage1_med_claims

</SQL>
    <Name>Tab 16</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <File>../../../../data/workforce/traffk/uhaul/pharmacy_analysis.sql</File>
    <Name>pharmacy_analysis</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <File>../../../../data/workforce/traffk/uhaul/wellness%20uhaul.sql</File>
    <Name>wellness uhaul</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>/*
update raw_tfk.table_name
set ins_med_eff_date = cast(med_eff_date as date) as med_eff_date;

update raw_tfk.table_name
set ins_med_term_date = cast(med_term_date as date) as med_term_date;
*/

drop table if exists  raw_tfk.contiguous_enrollment_table_uhaul20161108;
select   subid_encrypt||mbrid_encrypt as mbr_id1,mbrlast||mbrfirst||mbryob as mbr_id2,cast(segmenteffdt as date) as med_eff_date,cast(segmentenddt as date) as med_term_date,'UHAUL_Eligibility_201609.txt' as sourcefilename,*
into raw_tfk.contiguous_enrollment_table_uhaul20161108
from 
 raw_tfk.raw_bcbsal_uhaul_eligibility;

------------------------------------------------------------------------------------------------------------------------------------
--------------------------Rule_#C1--------------------------------------------
--Contiguous Ranking. 
--Add Rank by grouping  mbr_id and ordering on the basis of med_eff_date,file date and med_term_date. 
--med_term_date with open end date is considered as future date(2099-12-31).								
------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------



--select control_number,count(*) from  raw_tfk.contiguous_enrollment_table_uhaul20161108
--group by 1
--
--delete from  raw_tfk.contiguous_enrollment_table_uhaul20161108
--where control_number = '0397393'

--select distinct emp_cumbid,dep_cumbid,mbr_id from raw_tfk.contiguous_enrollment_table_uhaul20161108


drop table if exists raw_tfk.eff_date_ranks_table_uhaul20161108 ;

select distinct mbr_id1 as mbrid
,*,row_number() over(partition by mbr_id1 order by med_eff_date
,case sourcefilename 
 when 'UHAUL_Eligibility_201609.txt' then 1
else 99 end
, case when len(med_term_date)&gt;1 then cast(med_term_date as date) else cast('20991231' as date) end) as eff_date_rank
into raw_tfk.eff_date_ranks_table_uhaul20161108
from raw_tfk.contiguous_enrollment_table_uhaul20161108 a;

select * from raw_tfk.eff_date_ranks_table_uhaul20161108 
where mbrlast||mbrfirst||mbryob
in(
select distinct mbrlast||mbrfirst||mbryob from  temp_members_check_uhaul
group by 1
having count(distinct subid_encrypt||mbrid_encrypt)&gt;1)
order by mbr_id2,mbrlast,eff_date_rank


limit 1000;

--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------


---------------------------------------------------------------------------------------------------------------------------------------
--------------------------Rule_#C2--------------------------------------------

---------------------Contiguous Implementation without cutoff----------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

--Contiguous Create. For same member, compare consecutive record i.e Rank+1 = Rank then populate med_eff_date -1 as revised_termination_date. 
-----------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------


Drop table if exists raw_tfk.eff_date_ranks_table_uhaul20161108_unaltered;

create table raw_tfk.eff_date_ranks_table_uhaul20161108_unaltered
as
select * from raw_tfk.eff_date_ranks_table_uhaul20161108;

--update 
--raw_tfk.eff_date_ranks_table_uhaul20161108
--set med_term_date = cast('2099-12-31' as date)
--where med_term_date is null;

alter table raw_tfk.eff_date_ranks_table_uhaul20161108
add revised_termination_without_cutoff date;

--alter table raw_tfk.eff_date_ranks_table_uhaul20161108
--drop column revised_termination_without_cutoff;


update raw_tfk.eff_date_ranks_table_uhaul20161108
set revised_termination_without_cutoff = cast(raw_tfk.eff_date_ranks_table_uhaul20161108_unaltered.med_eff_date as date)
from raw_tfk.eff_date_ranks_table_uhaul20161108_unaltered
where raw_tfk.eff_date_ranks_table_uhaul20161108.mbrid=raw_tfk.eff_date_ranks_table_uhaul20161108_unaltered.mbrid
and raw_tfk.eff_date_ranks_table_uhaul20161108.eff_date_rank+1=raw_tfk.eff_date_ranks_table_uhaul20161108_unaltered.eff_date_rank
and raw_tfk.eff_date_ranks_table_uhaul20161108.med_term_date&gt;=raw_tfk.eff_date_ranks_table_uhaul20161108_unaltered.med_eff_date;



--select * from raw_tfk.eff_date_ranks_table_uhaul20161108 
--where mbrid in 
--(
--	select distinct mbrid from raw_tfk.eff_date_ranks_table_uhaul20161108
--	group by 1
--	having count(distinct med_eff_date)&gt;1)
--order by mbrid,eff_date_rank limit 1000;

-- 1st update--
----------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
Update raw_tfk.eff_date_ranks_table_uhaul20161108
set revised_termination_without_cutoff=dateadd(day,-1,revised_termination_without_cutoff)
where revised_termination_without_cutoff is not null ;

--select * from raw_tfk.eff_date_ranks_table_uhaul20161108
--order by mbrid limit 1000;


--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------


---------------------------------------------------------------------------------------------------------------------------------------
--------------------------Rule_#C3--------------------------------------------

---------------------Contiguous Update----------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------


--Contiguous Update. If revised_termination_without_cutoff_date is smaller than Effective_date then populate Effective_date as revised_termination_without_cutoff_date.
--If revised_termination_without_cutoff_date is greater than med_term_date than populate the value of med_term_date in revised_termination_without_cutoff_date 
--else populate revised_termination_without_cutoff_date. In case of blank or null revised_termination_without_cutoff_date, populate med_term_date. 
--Finally, consider revised_termination_without_cutoff_date as med_term_date.									



-- 2nd update--
----------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------
Update raw_tfk.eff_date_ranks_table_uhaul20161108
set revised_termination_without_cutoff=case when revised_termination_without_cutoff &lt; cast(med_eff_date as date) then cast(med_eff_date as date) else revised_termination_without_cutoff end
where revised_termination_without_cutoff is not null;

-- 3rd update --
----------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
Update raw_tfk.eff_date_ranks_table_uhaul20161108
set revised_termination_without_cutoff=case when len(med_term_date)&gt;1 and revised_termination_without_cutoff  is null then cast(med_term_date as date) else revised_termination_without_cutoff end 
where revised_termination_without_cutoff is null
and med_term_date is not null;


--select * from raw_tfk.eff_date_ranks_table_uhaul20161108
--order by mbrid,eff_date_rank  limit 1000;


--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------



---------------------Contiguous Implementation with cutoff----------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------
--In latest file, if the member have open end date or greater than cutoff date then copy date of med_term_date in revised_termination_without_cutoff_date.													
---------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

drop table if exists raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff;

create table raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff as 
select  *  from  raw_tfk.eff_date_ranks_table_uhaul20161108;

--alter table  raw_tfk.eff_date_ranks_table_uhaul20161108
--drop column revised_termination_with_cutoff;

alter table  raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff
add column revised_termination_with_cutoff date;


--select distinct sourcefilename from  raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff;
UPDATE raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff
SET revised_termination_with_cutoff = 
case
when sourcefilename = '20150723_Sheet1_EXTRACT_2K_0397393_BARNES.csv' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20150731' as date) then cast('20150731' as date)
when sourcefilename = '20151023_EXTRACT_MEA_0397393_004286_151013.csv' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20151031' as date) then cast('20151031' as date)
when sourcefilename = '20151101_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20151130' as date) then cast('20151130' as date)
when sourcefilename = '20151201_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20151231' as date) then cast('20151231' as date)
when sourcefilename = '20160101_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20160131' as date) then cast('20160131' as date)
when sourcefilename = '20160201_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20160229' as date) then cast('20160229' as date)
when sourcefilename = '20160301_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20160331' as date) then cast('20160331' as date)
when sourcefilename = '20160401_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20160430' as date) then cast('20160430' as date)
when sourcefilename = '20160519_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20160531' as date) then cast('20160531' as date)
when sourcefilename = '20160602_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20160630' as date) then cast('20160630' as date)
when sourcefilename = '20160701_BARNES_2KFile_0397393.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20160731' as date) then cast('20160731' as date)
when sourcefilename = '20160819_EXTRACT_MEA_0397393_002281_160817.txt' and isnull (cast (revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('20160831' as date) then cast('20160831' as date)
else cast (revised_termination_without_cutoff as date)
end;
------------------------------------------------------------
--------example---------------------------------------------------------------
--when sourcefilename =  'sourcefilename' and isnull(cast(revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('cycleEndDate'as date) then cast('filedate' as date)
--when sourcefilename = 'sourcefilename' and isnull(cast(revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('cycleEndDate'as date) then cast('filedate' as date)
--when sourcefilename = 'sourcefilename' and isnull(cast(revised_termination_without_cutoff as date),'2099-12-31')&gt;cast('cycleEndDate'as date) then cast('filedate' as date)


---------------------To retain the revised date as it for latest file ----------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------

update raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff
set revised_termination_with_cutoff = cast(med_term_date as date)
where sourcefilename = '20160819_EXTRACT_MEA_0397393_002281_160817.txt';



--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------



--------------------------------------------------------------------------------------------------------------------------------------------------------
------------Twin Cases---------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------


------------Insert into tmp_elig_twin table ---------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
/*drop table if exists tmp_elig_twin;
SELECT DISTINCT
 mbr_id
,mbr_first_name
,mbr_last_name
,mbr_dob
,mbr_gender
,mbr_relationship_code 
,DENSE_RANK() OVER (partition by (mbr_id)  ORDER BY mbr_first_name) AS MemIDSuffix
,sourcefilename 
INTO 
tmp_elig_twin
FROM
raw_tfk.tablename
WHERE 
mbr_last_name||cast(mbr_dob as varchar(20))||mbr_gender
IN
(
SELECT mbr_id  from raw_tfk.tablename
GROUP BY  mbr_last_name||cast(mbr_dob as varchar(20))||mbr_gender
HAVING COUNT(DISTINCT mbr_first_name)&gt;1
);
*/
---------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------

--select * from tmp_elig_twin;

------------Update raw table  ---------------------------- 
--------------------------------------------------------------------------------------------------------------------------------------------------------
------Apply if required ---------
----------------------------------------------------------
-- update raw_tfk.tablename
-- set (mbr_last_name||cast(mbr_dob as varchar(20))||mbr_gender)=b.mbr_id||b.memidsuffix
-- from tmp_elig_twin b
-- where raw_tfk.tablename .mbr_first_name=b.mbr_first_name
-- and raw_tfk.tablename .mbr_last_name=b.mbr_last_name
-- and raw_tfk.tablename .mbr_dob=b.mbr_dob
-- and raw_tfk.tablename .mbr_gender=b.mbr_gender


--------Member Month Calculation without cutoff logic--------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------
-- 5 Year Period MemberMonth
SELECT sourcefilename,extract(year from Ref_Date),extract(month from Ref_Date)
,count(distinct mbrid)
FROM   raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff a 
inner join
c.stage1_cms_bar_20160822.Ref_table_5year ref on (1=1)
left join 
(select value from c.stage1_cms_bar_20160822.makalu_config_params where name ='cycleEndDate') b ON (1=1)
WHERE
  (
       nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= coalesce(nullif(cast(a.med_term_date as date),'2099-12-31'),'2099-12-31')
       and  nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= cast(ref.Ref_Date as date)
       and coalesce(nullif(cast(a.med_term_date as date),'2099-12-31'),'2099-12-31') &gt;= cast(ref.Ref_Date as date)
	   and relationship_code in ('01', '')
   )
group by 1,extract(year from Ref_Date),extract(month from Ref_Date)
order by 1,2;


SELECT extract(year from Ref_Date),extract(month from Ref_Date)
,count(distinct mbrid)
FROM   raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff a 
inner join
c.stage1_cms_bar_20160822.Ref_table_5year ref on (1=1)
left join 
(select value from c.stage1_cms_bar_20160822.makalu_config_params where name ='cycleEndDate') b ON (1=1)
WHERE
  (
       nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= coalesce(nullif(cast(a.revised_termination_without_cutoff as date),'2099-12-31'),'2099-12-31')
       and  nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= cast(ref.Ref_Date as date)
       and coalesce(nullif(cast(a.revised_termination_without_cutoff as date),'2099-12-31'),'2099-12-31') &gt;= cast(ref.Ref_Date as date)
	  --  and relationship_code in ('01', '')
   )
group by extract(year from Ref_Date),extract(month from Ref_Date)
order by 1,2;



SELECT extract(year from Ref_Date),extract(month from Ref_Date)
,count(distinct mbrid)
FROM   raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff a 
inner join
c.stage1_cms_bar_20160822.Ref_table_5year ref on (1=1)
left join 
(select value from c.stage1_cms_bar_20160822.makalu_config_params where name ='cycleEndDate') b ON (1=1)
WHERE
  (
       nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= coalesce(nullif(cast(a.revised_termination_with_cutoff as date),'2099-12-31'),'2099-12-31')
       and  nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= cast(ref.Ref_Date as date)
       and coalesce(nullif(cast(a.revised_termination_with_cutoff as date),'2099-12-31'),'2099-12-31') &gt;= cast(ref.Ref_Date as date)
	    and relationship_code in ('01', '')
   )
group by extract(year from Ref_Date),extract(month from Ref_Date)
order by 1,2;







select mbrid,max(med_eff_date),max(revised_termination_with_cutoff)
from raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff a 
where mbrid in

--SELECT extract(year from Ref_Date),extract(month from Ref_Date)
--,count(distinct mbrid)
(select distinct mbrid 
FROM   raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff a 
inner join
c.stage1_cms_bar_20160822.Ref_table_5year ref on (1=1)
left join 
(select value from c.stage1_cms_bar_20160822.makalu_config_params where name ='cycleEndDate') b ON (1=1)
WHERE
  (
       nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= coalesce(nullif(cast(a.revised_termination_with_cutoff as date),'2099-12-31'),'2099-12-31')
       and  nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= cast('2016-07-31' as date) --cast(ref.Ref_Date as date)
       and coalesce(nullif(cast(a.revised_termination_with_cutoff as date),'2099-12-31'),'2099-12-31') &gt;= cast('2016-07-31' as date)--cast(ref.Ref_Date as date)
	    and relationship_code in ('01', '')
   ))
   group by 1
group by extract(year from Ref_Date),extract(month from Ref_Date)
order by 1,2;



select * from  raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff
where mbrid = 'W186309589'





select distinct sourcefilename from  raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff

SELECT sourcefilename,extract(year from Ref_Date),extract(month from Ref_Date)
,count(distinct mbrid)
FROM   raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff a 
inner join
c.stage1_cms_bar_20160822.Ref_table_5year ref on (1=1)
left join 
(select value from c.stage1_cms_bar_20160822.makalu_config_params where name ='cycleEndDate') b ON (1=1)
WHERE
  (
       nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= coalesce(nullif(cast(a.revised_termination_with_cutoff as date),'2099-12-31'),'2099-12-31')
       and  nullif(cast(a.med_eff_date as date), '2099-12-31') &lt;= cast(ref.Ref_Date as date)
       and coalesce(nullif(cast(a.revised_termination_with_cutoff as date),'2099-12-31'),'2099-12-31') &gt;= cast(ref.Ref_Date as date)
	    and relationship_code in ('')
		and sourcefilename = '20150723_Sheet1_EXTRACT_2K_0397393_BARNES.csv'
   )
group by 1,extract(year from Ref_Date),extract(month from Ref_Date)
order by 1,2,3;


select * from   raw_tfk.eff_date_ranks_table_uhaul20161108_cutoff 
where sourcefilename = '20150723_Sheet1_EXTRACT_2K_0397393_BARNES.csv'


</SQL>
    <Name>Tab 5</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <File>../../../../data/workforce/traffk/uhaul/medical%20import.sql</File>
    <Name>medical import</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <File>../../../../data/workforce/traffk/uhaul/member%20month.sql</File>
    <Name>member month</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>raw_tfk.raw_ethos_aetna_medical
ServicingProviderNPI 


select b.billtype,count(distinct ServicingProviderNPI),count(*),sum(cast(paidamount as float)/100) from raw_tfk.raw_ethos_aetna_medical a
left join master_deerwalk.dw_master_npi b
on a.ServicingProviderNPI &lt;&gt; b.npi 
and a.subgroup_nbr = '00000030'
group by 1


select distinct ServicingProviderNPI from raw_tfk.raw_ethos_aetna_medical a
where exists
(
	select null from master_deerwalk.dw_master_npi b
		where a.ServicingProviderNPI &lt;&gt; b.npi)

select sum(cast(paidamount as float)/100)  from raw_tfk.raw_ethos_aetna_medical
</SQL>
    <Name>Tab 18</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <File>../../../../data/workforce/traffk/uhaul/medical_analyisis.sql</File>
    <Name>medical_analyisis</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <File>../../../../data/workforce/traffk/uhaul/uhaul%20issues.sql</File>
    <Name>uhaul issues</Name>
  </Query>
  <Query IsView="False" IsSP="False">
    <SQL>select top 1 * from temp_test_datas

select * from temp_test_datas 
where value '^[A-Z]*$';


select * from temp_test_datas 
where value ~*'[^0-9]';



select distinct 
select distinct udf1 from  stage1_usi_20161201_i4.perm_stage1_eligibility;
select distinct udf1 from  stage1_usi_20161201_i4.perm_stage1_med_claims;
select distinct udf1 from  stage1_usi_20161201_i4.perm_stage1_rx_claims
where dw_rawfilename like '%archdipalrx20160630.TXT%';


select distinct MBR_NUM, brth_dt from raw_usi.raw_cigna_ecbarton_rxclaim	
limit 1000;
from </SQL>
    <Name>Tab 10</Name>
  </Query>
</QuerySet>